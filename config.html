

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Application Configuration &mdash; Ichnaea 1.4 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Ichnaea 1.4 documentation" href="index.html"/>
        <link rel="next" title="Development" href="development.html"/>
        <link rel="prev" title="Installing / Deploying" href="deploy.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Ichnaea
          

          
          </a>

          
            
            
              <div class="version">
                1.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using the Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="import_export.html">Data Import / Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy.html">Installing / Deploying</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Application Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#assets">Assets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cache">Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="#celery">Celery</a></li>
<li class="toctree-l2"><a class="reference internal" href="#database">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#geoip">GeoIP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sentry">Sentry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#statsd">StatsD</a></li>
<li class="toctree-l2"><a class="reference internal" href="#export">Export</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#bucket-export">Bucket Export</a></li>
<li class="toctree-l3"><a class="reference internal" href="#internal-export">Internal Export</a></li>
<li class="toctree-l3"><a class="reference internal" href="#https-export">HTTPS Export</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#import">Import</a></li>
<li class="toctree-l2"><a class="reference internal" href="#locate-fallback">Locate Fallback</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="calculation.html">Calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="internal_api/index.html">Internal Code API</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes/index.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Ichnaea</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Application Configuration</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/config.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="application-configuration">
<span id="config"></span><h1>Application Configuration<a class="headerlink" href="#application-configuration" title="Permalink to this headline">¶</a></h1>
<p>As part of deploying the application, you need to create an application
configuration file, commonly called <code class="docutils literal"><span class="pre">location.ini</span></code>.</p>
<p>As explained in the <a class="reference internal" href="deploy.html#deploy"><span>the deployment documentation</span></a> the
processes find this configuration file via the <code class="docutils literal"><span class="pre">ICHNAEA_CFG</span></code>
environment variable. The variable should contain an absolute path,
for example <code class="docutils literal"><span class="pre">/etc/location.ini</span></code>.</p>
<p>The configuration file is an ini-style file and contains a number of
different sections.</p>
<div class="section" id="assets">
<h2>Assets<a class="headerlink" href="#assets" title="Permalink to this headline">¶</a></h2>
<p>The assets section contains settings for a static file repository
(Amazon S3) and a public DNS to access those files via HTTPS
(Amazon CloudFront).</p>
<p>These are used to store and serve both the image tiles generated for
the data map and the public export files available via the downloads
section of the website.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[assets]</span>
<span class="na">bucket</span> <span class="o">=</span> <span class="s">amazon_s3_bucket_name</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">https://some_distribution_id.cloudfront.net</span>
</pre></div>
</div>
</div>
<div class="section" id="cache">
<h2>Cache<a class="headerlink" href="#cache" title="Permalink to this headline">¶</a></h2>
<p>The cache section contains a <code class="docutils literal"><span class="pre">cache_url</span></code> pointing to a Redis server.</p>
<p>The cache is used as a classic cache by the webapp code, as a backend
to store rate-limiting counters and as a custom queuing backend.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[cache]</span>
<span class="na">cache_url</span> <span class="o">=</span> <span class="s">redis://localhost:6379/0</span>
</pre></div>
</div>
</div>
<div class="section" id="celery">
<h2>Celery<a class="headerlink" href="#celery" title="Permalink to this headline">¶</a></h2>
<p>The celery section contains connection settings for the Celery asynchronous
task system.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[celery]</span>
<span class="na">broker_url</span> <span class="o">=</span> <span class="s">redis://localhost:6379/0</span>
<span class="na">result_url</span> <span class="o">=</span> <span class="s">redis://localhost:6379/0</span>
</pre></div>
</div>
</div>
<div class="section" id="database">
<h2>Database<a class="headerlink" href="#database" title="Permalink to this headline">¶</a></h2>
<p>The database section contains settings for accessing the MySQL database.</p>
<p>The web application only requires and uses the read-only connection,
while the asynchronous celery workers only use the read-write connection.</p>
<p>Both of them can be restricted to only DML (data-manipulation) permissions,
as neither needs DDL (data-definition) rights.</p>
<p>DDL changes are only done via the alembic database migration system,
which has a separate <code class="docutils literal"><span class="pre">alembic.ini</span></code> configuration file.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[database]</span>
<span class="na">rw_url</span> <span class="o">=</span> <span class="s">mysql+pymysql://rw_user:password@localhost/location</span>
<span class="na">ro_url</span> <span class="o">=</span> <span class="s">mysql+pymysql://ro_user:password@localhost/location</span>
</pre></div>
</div>
</div>
<div class="section" id="geoip">
<h2>GeoIP<a class="headerlink" href="#geoip" title="Permalink to this headline">¶</a></h2>
<p>The geoip section contains settings related to the maxmind GeoIP database.</p>
<p>The <code class="docutils literal"><span class="pre">db_path</span></code> setting needs to point to a maxmind GeoIP city database
in version 2 format. Both GeoLite and commercial databases will work.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[geoip]</span>
<span class="na">db_path</span> <span class="o">=</span> <span class="s">/path/to/GeoIP2-City.mmdb</span>
</pre></div>
</div>
</div>
<div class="section" id="sentry">
<h2>Sentry<a class="headerlink" href="#sentry" title="Permalink to this headline">¶</a></h2>
<p>The sentry section contains settings related to a Sentry server.</p>
<p>The <code class="docutils literal"><span class="pre">dsn</span></code> setting needs to contain a valid DSN project entry.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[sentry]</span>
<span class="na">dsn</span> <span class="o">=</span> <span class="s">https://public_key:secret_key@localhost/project_id</span>
</pre></div>
</div>
</div>
<div class="section" id="statsd">
<h2>StatsD<a class="headerlink" href="#statsd" title="Permalink to this headline">¶</a></h2>
<p>The statsd section contains settings related to a StatsD service. The
project uses a lot of metrics as further detailed in
<a class="reference internal" href="metrics.html#metrics"><span>the metrics documentation</span></a>.</p>
<p>The <code class="docutils literal"><span class="pre">host</span></code> and <code class="docutils literal"><span class="pre">port</span></code> settings determine how to connect to the service
via UDP.</p>
<p>Since a single StatsD service usually supports multiple different projects,
the <code class="docutils literal"><span class="pre">metric_prefix</span></code> setting can be used to prefix all metrics emitted
by this project with a unique name.</p>
<p>The <code class="docutils literal"><span class="pre">tag_support</span></code> setting can either be <code class="docutils literal"><span class="pre">false</span></code> or <code class="docutils literal"><span class="pre">true</span></code> and declares
whether or not the StatsD service supports metric tags.
<a class="reference external" href="https://www.datadoghq.com/">Datadog</a> is an example of a service that
supports tags. If <code class="docutils literal"><span class="pre">tag_support</span></code> is false, the tags will be emitted as
part of the standard metric name.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[statsd]</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">localhost</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">8125</span>
<span class="na">metric_prefix</span> <span class="o">=</span> <span class="s">location</span>
<span class="na">tag_support</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
</div>
<div class="section" id="export">
<h2>Export<a class="headerlink" href="#export" title="Permalink to this headline">¶</a></h2>
<p>The project supports exporting all data that its gets via the submit-style
APIs to different backends.</p>
<p>Currently three different kinds of backends are supported:</p>
<ul class="simple">
<li>Amazon S3 buckets</li>
<li>The projects own internal data processing pipeline</li>
<li>A HTTPS POST endpoint accepting the geosubmit v2 format</li>
</ul>
<p>The type of target is determined by the URL prefix of each section.
The section name must start with <code class="docutils literal"><span class="pre">export:</span></code> but the name postfix can
be anything.</p>
<p>All export targets can be configured with a <code class="docutils literal"><span class="pre">batch</span></code> setting that determines
how many reports have to be available before data is submitted to the
backend. Data is buffered in the Redis cache configured in the cache section.</p>
<p>All exports take an additional <code class="docutils literal"><span class="pre">skip_keys</span></code> setting as a whitespace
separated list of API keys. Data submitted using one of these API keys
will not be exported to the target.</p>
<p>There can be multiple instances of the bucket and HTTP POST export targets,
but only one instance of the internal export.</p>
<div class="section" id="bucket-export">
<h3>Bucket Export<a class="headerlink" href="#bucket-export" title="Permalink to this headline">¶</a></h3>
<p>The Amazon S3 bucket export combines reports into a gzipped JSON file
and uploads them to the specified bucket <code class="docutils literal"><span class="pre">url</span></code>.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[export:backup]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">s3://amazon_s3_bucket_name/directory/{api_key}/{year}/{month}/{day}</span>
<span class="na">skip_keys</span> <span class="o">=</span> <span class="s">test</span>
<span class="na">batch</span> <span class="o">=</span> <span class="s">10000</span>
</pre></div>
</div>
<p>The url can contain any level of additional static directories under the
bucket root. The <code class="docutils literal"><span class="pre">{api_key}/{year}/{month}/{day}</span></code> parts will be dynamically
replaced by the <cite>api_key</cite> used to upload the data, and the date when the
backup took place. The files use a random UUID4 as the filename.</p>
<p>An example filename might be:</p>
<div class="highlight-python"><div class="highlight"><pre>/directory/test/2015/07/15/554d8d3c-5b28-48bb-9aa8-196543235cf2.json.gz
</pre></div>
</div>
</div>
<div class="section" id="internal-export">
<h3>Internal Export<a class="headerlink" href="#internal-export" title="Permalink to this headline">¶</a></h3>
<p>The internal export forwards the incoming data into the internal data
pipeline. The url must be the exact string <code class="docutils literal"><span class="pre">internal://</span></code> and the
<code class="docutils literal"><span class="pre">metadata</span></code> setting must have a value of <code class="docutils literal"><span class="pre">true</span></code>.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[export:internal]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">internal://</span>
<span class="na">metadata</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">batch</span> <span class="o">=</span> <span class="s">1000</span>
</pre></div>
</div>
</div>
<div class="section" id="https-export">
<h3>HTTPS Export<a class="headerlink" href="#https-export" title="Permalink to this headline">¶</a></h3>
<p>The HTTPS export buffers incoming data into batches of <code class="docutils literal"><span class="pre">batch</span></code> size
and then submits them using the <a class="reference internal" href="api/geosubmit2.html#api-geosubmit-latest"><span>Geosubmit Version 2</span></a> API to the
specified <code class="docutils literal"><span class="pre">url</span></code> endpoint.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[export:test]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">https://localhost/some/api/url?key=export</span>
<span class="na">skip_keys</span> <span class="o">=</span> <span class="s">test</span>
<span class="na">batch</span> <span class="o">=</span> <span class="s">1000</span>
</pre></div>
</div>
<p>If the project is taking in data from a partner in a data exchange,
the <code class="docutils literal"><span class="pre">skip_keys</span></code> setting can be used to prevent data being roundtripped
and send back to the same partner that it came from.</p>
</div>
</div>
<div class="section" id="import">
<h2>Import<a class="headerlink" href="#import" title="Permalink to this headline">¶</a></h2>
<p>The project supports importing cell data on a regular basis from the
<a class="reference internal" href="glossary.html#term-opencellid"><span class="xref std std-term">OpenCellID</span></a> (OCID) project, using the
<a class="reference internal" href="import_export.html#import-export"><span>cell import/export</span></a> data format.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[import:ocid]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">https://localhost:7001/downloads/</span>
<span class="na">apikey</span> <span class="o">=</span> <span class="s">some_key</span>
</pre></div>
</div>
<p>The section name must be the exact string <code class="docutils literal"><span class="pre">import:ocid</span></code>. Both a <code class="docutils literal"><span class="pre">url</span></code>
and an <code class="docutils literal"><span class="pre">apikey</span></code> need to be configured for accessing an HTML overview
page listing the available download files using a specific file name pattern
for daily full and hourly differential files.</p>
<p>For the <a class="reference internal" href="glossary.html#term-opencellid"><span class="xref std std-term">OpenCellID</span></a> service, the URL must end with a slash.</p>
</div>
<div class="section" id="locate-fallback">
<h2>Locate Fallback<a class="headerlink" href="#locate-fallback" title="Permalink to this headline">¶</a></h2>
<p>The project can use not only its own internal data source, <a class="reference internal" href="glossary.html#term-ocid"><span class="xref std std-term">OCID</span></a>
cell data and GeoIP database, but also an external web service to answer
location queries.</p>
<p>The exactly named <code class="docutils literal"><span class="pre">locate:fallback</span></code> section describes settings related
to this external fallback service.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[locate:fallback]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">https://localhost/some/api/url?key=external</span>
<span class="na">ratelimit</span> <span class="o">=</span> <span class="s">60</span>
<span class="na">ratelimit_expire</span> <span class="o">=</span> <span class="s">120</span>
<span class="na">ratelimit_interval</span> <span class="o">=</span> <span class="s">60</span>
<span class="na">cache_expire</span> <span class="o">=</span> <span class="s">86400</span>
</pre></div>
</div>
<p>The url specifies the external endpoint supporting the
<a class="reference internal" href="api/geolocate.html#api-geolocate-latest"><span>Geolocate</span></a> API.</p>
<p>Requests to the fallback service can optionally be rate limited. Three
settings exist to configure the rate limit. <code class="docutils literal"><span class="pre">ratelimit</span></code> specifies how
many requests are allowed to be made. <code class="docutils literal"><span class="pre">ratelimit_interval</span></code> specifies
the interval in seconds for which the <code class="docutils literal"><span class="pre">ratelimit</span></code> number applies, so
for example one could configure 60 requests per 60 seconds, or 86400
requests per 86400 seconds (one day). Both would support on average
allow one request per second. The <code class="docutils literal"><span class="pre">ratelimit_expire</span></code> specifies the
number of seconds that the rate limit entries stay in the Redis cache
before they get expired and removed. The entry needs to be larger than
the <code class="docutils literal"><span class="pre">ratelimit_interval</span></code>.</p>
<p>Finally the fallback service might allow caching of results inside the
projects own Redis cache. <code class="docutils literal"><span class="pre">cache_expire</span></code> specifies the number of
seconds for which entries are allowed to be and should be cached.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="development.html" class="btn btn-neutral float-right" title="Development" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="deploy.html" class="btn btn-neutral" title="Installing / Deploying" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2015, Mozilla.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>