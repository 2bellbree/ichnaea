

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Development &mdash; Ichnaea 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Ichnaea 2.0 documentation" href="../index.html"/>
        <link rel="up" title="Installation" href="index.html"/>
        <link rel="next" title="Deployment" href="deploy.html"/>
        <link rel="prev" title="Installation" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Ichnaea
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Using the Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import_export.html">Data Export</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Installation</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Development</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker">Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code">Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#documentation">Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#css-js-images">CSS / JS / Images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-migrations">Database migrations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python-dependencies">Python Dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="deploy.html">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug.html">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html">Metrics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../algo/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changes/index.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ichnaea</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Installation</a> &raquo;</li>
        
      <li>Development</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/install/devel.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="development">
<span id="devel"></span><h1>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you want to install a production version of the code,
please skip these instructions and follow
<a class="reference internal" href="deploy.html#deploy"><span class="std std-ref">the deployment docs</span></a> instead.</p>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>In order to install a development version of the service, you need to
have a Linux or Mac OS machine and
<a class="reference external" href="https://docs.docker.com/installation/">install docker</a> and
docker-compose.</p>
<p>On Linux you can use your OS level package manager to install them.</p>
<p>On Mac OS you need to install
<a class="reference external" href="https://docs.docker.com/docker-for-mac/">Docker for Mac</a>.
Docker Toolbox or docker-machine based setups aren’t supported.</p>
</div>
<div class="section" id="docker">
<h2>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h2>
<p>We use docker to run the main application and additional development
dependencies like Redis and MySQL with the exact versions we want to
test against.</p>
<p>We assume that you can run <code class="docutils literal"><span class="pre">docker</span></code> and <code class="docutils literal"><span class="pre">docker-compose</span></code> on
your command line. Test this via:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker --version
docker-compose --version
</pre></div>
</div>
</div>
<div class="section" id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<p>Now run the following command to get the code:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git clone https://github.com/mozilla/ichnaea
<span class="nb">cd</span> ichnaea
git submodule update --init --recursive
</pre></div>
</div>
<p>For a development environment, you need to use the <code class="docutils literal"><span class="pre">./dev</span></code> helper
script to download and create all the required docker containers.
As a first command you can use:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./dev <span class="nb">test</span>
</pre></div>
</div>
<p>The first time around it’ll take a good while. This will also start
a container running MySQL and one running Redis.</p>
<p>Please note that running the tests will wipe the database and Redis
instance it is connected to. DO NOT USE the dev helper script for
a production install.</p>
<p>Next up, you can run the entire application, with its three different
application containers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./dev start
</pre></div>
</div>
<p>This will start a web, worker and scheduler container.</p>
<p>It will also expose port 8000 of the web container on localhost, so
you can interact with the web site directly, without having to use the
IP address of the web container.</p>
<p>The dev script provides a couple more commands, to control and
interact with the containers.</p>
<p>There are start/stop/restart commands to interact with all containers.
Each of these commands also takes a second argument of either
scheduler, services, web or worker. This allows you to start and stop
only a specific type of container.</p>
<p>The dev script also reacts to a <cite>PULL</cite> environment variable, which
allows you to skip pulling for new docker images during each invocation.
Prefix the command with <cite>PULL=0</cite>, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">PULL</span><span class="o">=</span><span class="m">0</span> ./dev start
</pre></div>
</div>
<p>To interact and inspect the application image, there is one more helper
command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./dev shell
</pre></div>
</div>
<p>This will drop you into a bash shell inside a container based on the
application image.</p>
</div>
<div class="section" id="unit-tests">
<h2>Unit Tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The tests clear out the databae and Redis on each test run,
so don’t run these against a production instance or you will
loose all your data.</p>
</div>
<p>If you have a local development environment, you can run all tests
including coverage tests via:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./dev <span class="nb">test</span>
</pre></div>
</div>
<p>Or run individual test modules via for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./dev <span class="nb">test</span> <span class="nv">TESTS</span><span class="o">=</span>ichnaea.tests.test_geoip
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since the tests use a real database and Redis connection,
you cannot parallelize any tests.</p>
</div>
</div>
<div class="section" id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h2>
<p>In order to create and test the documentation locally run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./dev docs
</pre></div>
</div>
<p>This will create an application container with a volume mount to the
local <code class="docutils literal"><span class="pre">docs/build/html</span></code> directory and update the documentation so
it is available in that local directory.</p>
<p>To view the documentation open <code class="docutils literal"><span class="pre">file://docs/build/html/index.html</span></code>
with a web brower.</p>
</div>
<div class="section" id="css-js-images">
<h2>CSS / JS / Images<a class="headerlink" href="#css-js-images" title="Permalink to this headline">¶</a></h2>
<p>The project depends on a number of external web assets. Those dependencies
are tracked via npm in files under <cite>docker/node</cite>.</p>
<p>In order to install them, run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./dev css
./dev js
</pre></div>
</div>
<p>This will install build tools and assets inside a docker container.
It will also copy, compile and minify files in various folders under
<cite>ichnaea/content/static/</cite>.</p>
</div>
<div class="section" id="database-migrations">
<h2>Database migrations<a class="headerlink" href="#database-migrations" title="Permalink to this headline">¶</a></h2>
<p>The codebase uses a library called
<a class="reference external" href="http://alembic.zzzcomputing.com/en/latest/">alembic</a>
to faciliate database migrations.</p>
<p>To create a new database migration step, start an application container
with an open shell:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./dev shell
</pre></div>
</div>
<p>Create a new file via:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>bin/alembic revision -m <span class="s1">&#39;Drop OCID tables&#39;</span>
</pre></div>
</div>
<p>Use a short description for the <cite>-m</cite> argument, as it will become part of the
generated file name. The output of the above command should be something
like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Generating /app/ichnaea/alembic/versions/138cb0d71dfb_drop_ocid_tables.py ... <span class="k">done</span>
</pre></div>
</div>
<p>Copy the generated file out of the running container and into the codebase.
While the container is still running, open a seperate terminal on your
host machine and call:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker cp location_shell:/app/ichnaea/alembic/versions/138cb0d71dfb_drop_ocid_tables.py <span class="se">\</span>
    ichnaea/alembic/versions/
</pre></div>
</div>
<p>Afterwards you can exit the container. Don’t forget to <cite>git add</cite> the new file.</p>
</div>
<div class="section" id="python-dependencies">
<h2>Python Dependencies<a class="headerlink" href="#python-dependencies" title="Permalink to this headline">¶</a></h2>
<p>The project uses <a class="reference external" href="https://requires.io/github/mozilla/ichnaea/requirements/?branch=master">requires.io</a>
to track whether or not the Python dependencies are outdated.</p>
<p>If they are, update the version pins in the various <cite>requirements/*.txt</cite>
files and rerun <cite>./dev test</cite> and <cite>./dev docs</cite>.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="deploy.html" class="btn btn-neutral float-right" title="Deployment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2017, Mozilla.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>