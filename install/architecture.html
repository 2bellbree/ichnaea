

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Architecture &mdash; Ichnaea 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Ichnaea 2.0 documentation" href="../index.html"/>
        <link rel="up" title="Installation" href="index.html"/>
        <link rel="next" title="Algorithms" href="../algo/index.html"/>
        <link rel="prev" title="Metrics" href="metrics.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Ichnaea
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Using the Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import_export.html">Data Export</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Installation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="devel.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy.html">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug.html">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html">Metrics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hardware-stack">Hardware Stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="#software-stack">Software Stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-pipeline">Data Pipeline</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#submit-api">Submit API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#web-service">Web Service</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../algo/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changes/index.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ichnaea</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Installation</a> &raquo;</li>
        
      <li>Architecture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/install/architecture.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="architecture">
<span id="id1"></span><h1>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The application consists of a streaming data pipeline, a HTTP web service
and a normal web site.</p>
</div>
<div class="section" id="hardware-stack">
<h2>Hardware Stack<a class="headerlink" href="#hardware-stack" title="Permalink to this headline">¶</a></h2>
<p>In terms of physical resources it’s helpful to look at a diagram of a
typical full deployment in an AWS environment:</p>
<a class="reference internal image-reference" href="../_images/deploy.png"><img alt="Deployment Diagram" src="../_images/deploy.png" style="width: 720.0px; height: 930.0px;" /></a>
<p>Major components are MySQL and Redis in addition to load balancers,
web servers and Amazon S3.</p>
</div>
<div class="section" id="software-stack">
<h2>Software Stack<a class="headerlink" href="#software-stack" title="Permalink to this headline">¶</a></h2>
<p>On the software side, the application is complex and based on many different
libraries and frameworks. The streaming data pipeline is a combination
of the Python Celery framework, its Celery scheduler and custom logic
based on Redis. The web service and web site are based on the
Python Pyramid web framework.</p>
<p>In addition to those larger frameworks many other Python libraries are used
including Cython, gevent, numpy/scipy, maxminddb, pytest, Rtree, Shapely
and SQLAlchemy.</p>
<p>There are also a good number of C/C++ libraries and command line programs
involved, like libgeos, libspatialindex, libmaxminddb, pngquant and a
tool called datamaps for generating the coverage data map tiles.</p>
</div>
<div class="section" id="data-pipeline">
<h2>Data Pipeline<a class="headerlink" href="#data-pipeline" title="Permalink to this headline">¶</a></h2>
<p>The data pipeline is based on recurring tasks scheduled via the Celery
scheduler. These process data in batches, stored in custom Redis Queues
(implemented as Redis lists). Celery tasks themselves don’t contain any
data payload, but merely act as triggers to process the seperate queues.</p>
<p>The pipeline itself makes no at-most or at-least once delivery
guaruantees, but is based on a best-effort approach. The assumption is
that most of the data is being sent to the service repeatedly and missing
some small percentage doesn’t negatively impact the data quality. At
the same time since redundant data is being processed by the system
in any case, a small number of additional cases of duplicated data
processing caused by the pipeline itself doesn’t hurt much either.</p>
<p>In more technical concrete terms, the typical data flow of an incoming
request looks like this:</p>
<div class="section" id="submit-api">
<h3>Submit API<a class="headerlink" href="#submit-api" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>The Web frontend stores data in Redis (<cite>update_incoming</cite>)</li>
<li>The Celery scheduler plans the execution of the <cite>update_incoming</cite> task.</li>
<li>The Celery Async worker executes the <cite>update_incoming</cite> task, this task
acts as a multiplexer and depends on the <cite>export_config</cite> database table.
Typically data is forwared into a backup job, storing data in S3, a
internal processing job to update the database contents and an external
data sharing job, to share the data with one or more external partners.</li>
<li>The <cite>update_incoming</cite> stores data in multiple Redis lists, for example
<cite>queue_export_internal</cite> and one more <cite>queue_export_*</cite> for each export
target. These targets all have different batch intervals, so data is
duplicated at this point. The job checks the length and last processing
time of each queue and schedules a <cite>export_reports</cite> job per target.</li>
<li>The async worker export reports job either assembles the data to store
in S3, upload it to an external web service or prepares it for internal
processing. The internal processing job splits the reports into its
parts, creating one observation per network and queues them into
multiple queues, one queue corresponding to one database table shard.
This data ends up in Redis queues like <cite>update_cell_gsm</cite>,
<cite>update_cell_wcdma</cite>, <cite>update_wifi_0</cite>, <cite>update_wifi_1</cite>, etc. The job
also fills the <cite>update_datamap</cite> queue, to update the coverage data
map on the web site.</li>
<li>The celery scheduler again plans a <cite>station updater</cite> job for each type
of network, for example an <cite>update_wifi</cite> task. These jobs take in the
new batch of observations and match them against the known database
contents. As a result network positions can be modified, new networks
be added or old networks be marked as blocklisted, noting that they’ve
recently moved from their old position.</li>
</ul>
</div>
</div>
<div class="section" id="web-service">
<h2>Web Service<a class="headerlink" href="#web-service" title="Permalink to this headline">¶</a></h2>
<p>The web service offers a couple of different HTTP APIs. As a first step
the service needs to validate the API key in the request. In order to avoid
doing a database backend lookup on each request, the web service frontend
uses an in-memory API key cache with a livetime of 5 minutes with some
additional jitter.</p>
<p>As a second step some requests contain only the orginating IP address
of the request without any additional information about Bluetooth, Cell
or WiFi networks. These requests are answered based on the locally
available Maxmind GeoIP database, again avoiding any backend database
lookup. A backend request to Redis is still made to track API key usage
and maintain a Redis HyperLogLog counting the number of unique IP
addresses making service requests.</p>
<p>Should the request contain additional network information, this
information is matched against a list of <cite>location providers</cite>. These
are responsible for matching the data against the internal database
structures and generate possible result values and corresponding
data quality / trustworthiness scores.</p>
<p>Some API keys allow falling back on an external web service if the best
internal result does not match the expected accuracy/precision of the
incoming query. In those cases an additional HTTPS request is made to
an external service and their result is considered as a possible result
in addition to the internal ones.</p>
<p>Generally speaking the system only deals with probabilities, fuzzy matches
and has to consider multiple plausible results for each incoming query.
The database contents will always represent a view of the world which is
outdated, compared to the changes in the real world.</p>
<p>Should the service be able to generate a plausible and good enough
answer, this is send back as a response. The incoming query and this
answer is also stored in another queue, to be picked up by the data
pipeline later. This query based data is used to in/validate the database
contents and estimate the position of previously unknown networks as
to be near the already known networks.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../algo/index.html" class="btn btn-neutral float-right" title="Algorithms" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="metrics.html" class="btn btn-neutral" title="Metrics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2017, Mozilla.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>