

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Deployment &mdash; Ichnaea 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Ichnaea 2.0 documentation" href="../index.html"/>
        <link rel="up" title="Installation" href="index.html"/>
        <link rel="next" title="Configuration" href="config.html"/>
        <link rel="prev" title="Development" href="devel.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Ichnaea
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Using the Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import_export.html">Data Export</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Installation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="devel.html">Development</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Deployment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#diagram">Diagram</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mysql-amazon-rds">MySQL / Amazon RDS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#redis-amazon-elasticache">Redis / Amazon ElastiCache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#amazon-s3">Amazon S3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#statsd-sentry">Statsd / Sentry</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-tiles">Image Tiles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-config">Docker Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-setup">Database Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#geoip">GeoIP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-runtime">Docker Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="#runtime-checks">Runtime Checks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upgrade">Upgrade</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug.html">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../algo/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changes/index.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ichnaea</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Installation</a> &raquo;</li>
        
      <li>Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/install/deploy.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deployment">
<span id="deploy"></span><h1>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h1>
<p>We deploy ichnaea in an Amazon AWS environment, and there are some
optional dependencies on specific AWS services like Amazon S3. The
documentation assumes you are also using a AWS environment, but ichnaea
can be run in non-AWS environments as well.</p>
<div class="section" id="diagram">
<h2>Diagram<a class="headerlink" href="#diagram" title="Permalink to this headline">¶</a></h2>
<p>A full deployment of the application in an AWS environment can include all
of the parts shown in the diagram, but various of these parts are optional:</p>
<a class="reference internal image-reference" href="../_images/deploy.png"><img alt="Deployment Diagram" src="../_images/deploy.png" style="width: 720.0px; height: 930.0px;" /></a>
<p>Specifically Amazon CloudFront and S3 are only used for backup and serving
image tiles and public data downloads for the public website.
Using Combain, Datadog, OpenCellID and Sentry is also optional.
Finally there doesn’t have to be a <cite>admin</cite> EC2 box, but it can be helpful
for debug access and running database migrations.</p>
</div>
<div class="section" id="mysql-amazon-rds">
<h2>MySQL / Amazon RDS<a class="headerlink" href="#mysql-amazon-rds" title="Permalink to this headline">¶</a></h2>
<p>The application is written and tested against MySQL 5.7.x or Amazon RDS
of the same versions. The default configuration works for the most part.
There are just a couple of changes you need to do.</p>
<p>For example via the my.cnf:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[mysqld]</span>
<span class="na">character-set-server</span> <span class="o">=</span> <span class="s">utf8</span>
<span class="na">collation-server</span> <span class="o">=</span> <span class="s">utf8_general_ci</span>
<span class="na">init-connect</span><span class="o">=</span><span class="s">&#39;SET NAMES utf8&#39;</span>
</pre></div>
</div>
<p>The web frontend role only needs access to a read-only version of
the database, for example a read-replica. The worker backend role
needs access to the read-write primary database.</p>
<p>You need to create a database called <cite>location</cite> and a user with DDL
privileges for that database.</p>
</div>
<div class="section" id="redis-amazon-elasticache">
<h2>Redis / Amazon ElastiCache<a class="headerlink" href="#redis-amazon-elasticache" title="Permalink to this headline">¶</a></h2>
<p>The application uses Redis as a queue for the asynchronous task workers and
also uses it directly as a cache and to track API key rate limitations.</p>
<p>You can install a standard Redis or use Amazon ElastiCache (Redis).
The application is tested against Redis 3.2.</p>
</div>
<div class="section" id="amazon-s3">
<h2>Amazon S3<a class="headerlink" href="#amazon-s3" title="Permalink to this headline">¶</a></h2>
<p>The application uses Amazon S3 for various tasks, including backup of
<a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a>, export of the aggregated cell table and hosting of
the data map image tiles.</p>
<p>All of these are triggered by asynchronous jobs and you can disable them
if you are not hosted in an AWS environment.</p>
<p>If you use Amazon S3 you might want to configure a lifecycle policy to
delete old export files after a couple of days and <a class="reference internal" href="../glossary.html#term-observation"><span class="xref std std-term">observation</span></a>
data after one year.</p>
</div>
<div class="section" id="statsd-sentry">
<h2>Statsd / Sentry<a class="headerlink" href="#statsd-sentry" title="Permalink to this headline">¶</a></h2>
<p>The application uses Statsd to aggregate metrics and Sentry to log
exception messages.</p>
<p>To use Statsd and Sentry, you need to configure them via environment
variables as detailed in <a class="reference internal" href="config.html#config"><span class="std std-ref">the config section</span></a>.</p>
<p>Installation of Statsd and Sentry are outside the scope of this documentation.</p>
</div>
<div class="section" id="image-tiles">
<h2>Image Tiles<a class="headerlink" href="#image-tiles" title="Permalink to this headline">¶</a></h2>
<p>The code includes functionality to render out image tiles for a data map
of places where observations have been made.</p>
<p>You can trigger this functionality periodically via a cron job, by
calling the application container with the map argument.</p>
</div>
<div class="section" id="docker-config">
<h2>Docker Config<a class="headerlink" href="#docker-config" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="devel.html#devel"><span class="std std-ref">the development section</span></a> describes how to set up an
environment used for working on and developing Ichnaea itself. For a
production install, you should use pre-packaged docker images, instead
of installing and setting up the code from Git.</p>
<p>Start by looking up the version number of the last stable release on
<a class="reference external" href="https://github.com/mozilla/ichnaea/releases">https://github.com/mozilla/ichnaea/releases</a>.</p>
<p>Than get the corresponding docker image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker pull mozilla/location:2.1.0
</pre></div>
</div>
<p>To test if the image was downloaded successfully, you can create a
container and open a shell inside of it:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker run -it --rm mozilla/location:2.1.0 shell
</pre></div>
</div>
<p>Close the container again, either via <code class="docutils literal"><span class="pre">exit</span></code> or <code class="docutils literal"><span class="pre">Ctrl-D</span></code>.</p>
<p>Next up create the application config as a docker environment file,
for example called <cite>env.txt</cite>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">DB_HOST</span><span class="o">=</span><span class="s">domain.name.for.mysql</span>
<span class="na">DB_USER</span><span class="o">=</span><span class="s">location</span>
<span class="na">DB_PASSWORD</span><span class="o">=</span><span class="s">secret</span>
<span class="na">GEOIP_PATH</span><span class="o">=</span><span class="s">/app/geoip/GeoLite2-City.mmdb</span>
<span class="na">REDIS_HOST</span><span class="o">=</span><span class="s">domain.name.for.redis</span>
</pre></div>
</div>
<p>You can use either a single database user with DDL/DML privileges
(<cite>DB_USER</cite> / <cite>DB_PASSWORD</cite>) or separate users for DDL, read-write and
read-only privileges as detailed in <a class="reference internal" href="config.html#config"><span class="std std-ref">the config section</span></a>.</p>
</div>
<div class="section" id="database-setup">
<h2>Database Setup<a class="headerlink" href="#database-setup" title="Permalink to this headline">¶</a></h2>
<p>The user with DDL privileges and a database called <cite>location</cite> need to
be created manually. If multiple users are used, the initial database
setup will create the read-only / read-write users.</p>
<p>Next up, run the initial database setup:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker run -it --rm --env-file env.txt <span class="se">\</span>
    mozilla/location:2.1.0 alembic stamp base
</pre></div>
</div>
<p>And update the database schema to the latest version:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker run -it --rm --env-file env.txt <span class="se">\</span>
    mozilla/location:2.1.0 alembic upgrade head
</pre></div>
</div>
<p>The last command needs to be run whenever you upgrade to a new version
of ichnaea. You can inspect available database schema changes via
alembic with the <cite>history</cite> and <cite>current</cite> sub-commands.</p>
</div>
<div class="section" id="geoip">
<h2>GeoIP<a class="headerlink" href="#geoip" title="Permalink to this headline">¶</a></h2>
<p>The application uses a Maxmind GeoIP City database for various tasks.
It works both with the commerically available and Open-Source GeoLite
databases in binary format.</p>
<p>You can download the
<a class="reference external" href="https://dev.maxmind.com/geoip/geoip2/geolite2/">GeoLite database</a> from
<a class="reference external" href="https://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz">https://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</a></p>
<p>Download and untar the downloaded file. Put the <cite>GeoLite2-City.mmdb</cite>
into a directory accessible to docker (for example <cite>/opt/geoip</cite>).
The directory will get volume mounted into the running docker containers.</p>
<p>You can update this file on a regular basis. Typically once a month
is enough for the GeoLite database. Make sure to stop any containers
accessing the file before updating it and start them again afterwards.
The application code doesn’t tolerate having the file being changed
underneath it.</p>
</div>
<div class="section" id="docker-runtime">
<h2>Docker Runtime<a class="headerlink" href="#docker-runtime" title="Permalink to this headline">¶</a></h2>
<p>Finally you are ready to start containers for the three different
application roles.</p>
<p>There is a web frontend, async worker and async scheduler role.
The scheduler role is limited to a single running container. You need
to make sure to never have two containers for the scheduler running at
the same time. If you use multiple physical machines, the scheduler
must only run on one of them.</p>
<p>The web app and async worker roles both scale out and you can run
as many of them as you want. They internally look at the number of
available CPU cores in the docker container and run an appropriate
number of sub-processes. So you can run a single docker container
per physical/virtual machine.</p>
<p>All roles communicate via the database and Redis only, so can be run
on different virtual or physical machines. The async workers load
balance their work internally via data structures in Redis.</p>
<p>If you run multiple web frontend roles, you need to put a load balancer
in front of them. The application does not use any sessions or cookies,
so the load balancer can simply route traffic via round-robin.</p>
<p>You can configure the load balancer to use the <cite>/__lbheartbeat__</cite> HTTP
endpoint to check for application health.</p>
<p>If you want to use docker as your daemon manager run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker run -d --env-file env.txt <span class="se">\</span>
    --volume /opt/geoip:/app/geoip
    mozilla/location:2.1.0 scheduler
</pre></div>
</div>
<p>The <cite>/opt/geoip</cite> directory is the directory on the docker host, with
the <cite>GeoLite2-City.mmdb</cite> file inside it. The <cite>/app/geoip/</cite> directory
corresponds to the <cite>GEOIP_PATH</cite> config section in the <cite>env.txt</cite> file.</p>
<p>The two other roles are started in the same way:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker run -d --env-file env.txt <span class="se">\</span>
    --volume /opt/geoip:/app/geoip
    mozilla/location:2.1.0 worker

docker run -d --env-file env.txt <span class="se">\</span>
    --volume /opt/geoip:/app/geoip
    -p <span class="m">8000</span>:8000/tcp
    mozilla/location:2.1.0 web
</pre></div>
</div>
<p>The web role can take an additional argument to map the port 8000 from
inside the container to port 8000 of the docker host machine.</p>
<p>You can put a web server (e.g. Nginx) in front of the web role and
proxy pass traffic to the docker container running the web frontend.</p>
</div>
<div class="section" id="runtime-checks">
<h2>Runtime Checks<a class="headerlink" href="#runtime-checks" title="Permalink to this headline">¶</a></h2>
<p>To check whether or not the application is running, you can check the
web role, via:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>curl -i http://localhost:8000/__heartbeat__
</pre></div>
</div>
<p>This should produce output like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">gunicorn</span><span class="o">/</span><span class="mf">19.7</span><span class="o">.</span><span class="mi">1</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">04</span> <span class="n">Jul</span> <span class="mi">2017</span> <span class="mi">13</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">13</span> <span class="n">GMT</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
<span class="n">Access</span><span class="o">-</span><span class="n">Control</span><span class="o">-</span><span class="n">Allow</span><span class="o">-</span><span class="n">Origin</span><span class="p">:</span> <span class="o">*</span>
<span class="n">Access</span><span class="o">-</span><span class="n">Control</span><span class="o">-</span><span class="n">Max</span><span class="o">-</span><span class="n">Age</span><span class="p">:</span> <span class="mi">2592000</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">125</span>

<span class="p">{</span><span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
 <span class="s2">&quot;geoip&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;age_in_days&quot;</span><span class="p">:</span> <span class="mi">389</span><span class="p">},</span>
 <span class="s2">&quot;redis&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
</pre></div>
</div>
<p>The <cite>__lbheartbeat__</cite> endpoint has simpler output and doesn’t check
the database / Redis backend connections. The application is designed
to degrade gracefully and continue to work with limited capabilities
without working database and Redis backends.</p>
<p>The <cite>__version__</cite> endpoint shows what version of the software is
currently running.</p>
<p>To test one of the HTTP API endpoints, you can use:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>curl -H <span class="s2">&quot;X-Forwarded-For: 81.2.69.192&quot;</span> <span class="se">\</span>
    http://localhost:8000/v1/geolocate?key<span class="o">=</span><span class="nb">test</span>
</pre></div>
</div>
<p>This should produce output like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">51.5142</span><span class="p">,</span> <span class="s2">&quot;lng&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0931</span><span class="p">}</span>
</pre></div>
</div>
<p>Test this with different IP addresses like <cite>8.8.8.8</cite> to make sure
the database file was picked up correctly.</p>
</div>
<div class="section" id="upgrade">
<h2>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this headline">¶</a></h2>
<p>In order to upgrade a running installation of ichnaea to a new version,
first check and get the docker image for the new version, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker pull mozilla/location:2.2.0
</pre></div>
</div>
<p>Next up stop all containers running the scheduler and async worker roles.
If you use docker’s own daemon support, the <cite>ps</cite>, <cite>stop</cite> and <cite>rm</cite> commands
can be used to accomplish this.</p>
<p>Now run the database migrations found in the new image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker run -it --rm --env-file env.txt <span class="se">\</span>
    mozilla/location:2.2.0 alembic upgrade head
</pre></div>
</div>
<p>The web app role can work with both the old database and new database
schemas. The worker role might require the new database schema right
away.</p>
<p>Start containers for the scheduler, worker and web roles based on the
new image.</p>
<p>Depending on how you run your web tier, swich over the traffic from
the old web containers to the new ones. Once all traffic is going to
the new web containers, stop the old web containers.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="config.html" class="btn btn-neutral float-right" title="Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="devel.html" class="btn btn-neutral" title="Development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2017, Mozilla.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>