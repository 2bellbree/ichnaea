version: 2
jobs:
  build:
    branches:
        ignore:
            # Old feature branch
            - 1.5.x
            # Generated docs hosted on GitHub
            - gh-pages
            # 2015 experiment to use ReadTheDocs
            - readthedocs
    docker:
      - image: mozilla/cidockerbases:docker-latest
    working_directory: /

    steps:
        - run:
            name: Host info
            command: uname -v

        - run:
            name: Install essential packages
            command: |
                apt-get update

        - checkout:
            path: /ichnaea

        - run:
            name: Create version.json
            working_directory: /ichnaea
            command: |
                # create a version.json per https://github.com/mozilla-services/Dockerflow/blob/master/docs/version_object.md
                printf '{"commit":"%s","version":"%s","source":"https://github.com/%s/%s","build":"%s"}\n' \
                "$CIRCLE_SHA1" \
                "$CIRCLE_TAG" \
                "$CIRCLE_PROJECT_USERNAME" \
                "$CIRCLE_PROJECT_REPONAME" \
                "$CIRCLE_BUILD_URL" > /ichnaea/version.json

        - store_artifacts:
            path: /ichnaea/version.json

        - setup_remote_docker

        - run:
            name: Get Info
            command: |
               docker info
               which docker-compose
               docker-compose --version

        - run:
            name: Build Docker images
            working_directory: /ichnaea
            command: |
                docker build -t ${DOCKERHUB_REPO:-mozilla/location} .

        - run:
            name: Run tests
            working_directory: /ichnaea
            command: |
                ./dev test
