<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal">
<head>
  <meta charset="UTF-8" />
  <title>Mozilla Location Service - Statistics</title>

  <link rel="stylesheet" href="/static/css/base.css" />
  <link rel="stylesheet" href="/static/rickshaw.min.css" />

  <script src='/static/jquery.min.js'></script>
  <script src='/static/d3.min.js'></script>
  <script src='/static/d3.layout.min.js'></script>
  <script src='/static/rickshaw.min.js'></script>
</head>
<body>
<div id="outer-wrapper">

<div id="wrapper">
    <header id="masthead">
        <nav id="nav-main" role="navigation">
            <ul id="nav-main-menu">
                <li class="first"><a href="/">Home</a></li>
                <li><a href="/stats">Statistics</a></li>
                <li class="last"><a href="/map">Map</a></li>
            </ul>
        </nav>

        <h2><a href="/">Mozilla Location Service</a></h2>
    </header>
</div>

<h1 id="main-feature">Statistics</h1>

<section id="main-content">
    <p>Overall statistics and leaderboard.</p>
    <h2>Measurements</h2>
    <p>Total measurements:
        <span id="total_measurements">${total_measures}</span>
    </p>
    <h3>New measurements in the last 30 days</h3>
    <div id="chart_container">
            <div id="y_axis"></div>
            <div id="chart"></div>
            <div id="x_axis"></div>
    </div>
    <h2>Leaders</h2>
    <div id="leader_container">
        <table id="leader_table" class="table">
            <thead>
                <tr>
                    <th>User (token)</th>
                    <th>Contributed measurements</th>
                </tr>
            </thead>
            <tbody>
                <tr tal:repeat="row leaders">
                    <td>${row.nickname} (${row.token}&hellip;)</td>
                    <td>${row.num}</td>
                </tr>
            </tbody>
        </table>
    </div>
</section>

<footer id="colophon">
    <div class="footer-logo">
        <img src="/static/images/mozilla-logo.png" alt="Mozilla" />
    </div>
    <div class="footer-license">
        This content is ©2012–2013 by Mozilla.
    </div>

    <ul class="footer-nav">
        <li><a href="https://wiki.mozilla.org/Services/Location">
            Project overview</a>
        </li>
        <li><a href="https://github.com/mozilla/ichnaea/">
            Source Code</a>
        </li>
    </ul>
</footer>
</div>

<script type='text/javascript'>

var result = {};
$.ajax({
    url: '/v1/stats',
    dataType: "json",
    async: false,
    success: function(json) {
        result = json;
    }
});

var entries = [];
for (var i = 0; i < result.histogram.length; i++) {
    item = result.histogram[i];
    entries.push({x: Date.parse(item.day), y: item.num});
};

var graph = new Rickshaw.Graph( {
    element: document.querySelector("#chart"),
    width: 600,
    height: 240,
    series: [ {
            data: entries, 
            color: 'steelblue'
    } ]
} );

var format_date = function(n) {
    var d = new Date(0);
    d.setUTCMilliseconds(n);
    return d.toLocaleDateString();
};

var x_axis = new Rickshaw.Graph.Axis.X( {
    graph: graph,
    orientation: 'bottom',
    element: document.getElementById('x_axis'),
    pixelsPerTick: 100,
    tickFormat: format_date,
} );

var y_axis = new Rickshaw.Graph.Axis.Y( {
    graph: graph,
    orientation: 'left',
    tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
    element: document.getElementById('y_axis'),
} );

graph.render();

</script>
</body>
</html>
