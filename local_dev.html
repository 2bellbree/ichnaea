

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Local development environment &mdash; Ichnaea 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Ichnaea 2.0 documentation" href="index.html"/>
        <link rel="next" title="Services API" href="api/index.html"/>
        <link rel="prev" title="Using the Service" href="usage.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Ichnaea
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using the Service</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Local development environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup-quickstart">Setup Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updating-the-dev-environment">Updating the Dev Environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#updating-code">Updating code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-configuration-specific-to-your-local-dev-environment">Setting configuration specific to your local dev environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overriding-configuration">Overriding configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#alembic-and-database-migrations">Alembic and Database Migrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-static-assets-css-js">Building Static Assets (CSS/JS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-tests">Running Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-docs">Building Docs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="import_export.html">Data Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="algo/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes/index.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Ichnaea</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Local development environment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/local_dev.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="local-development-environment">
<h1><a class="toc-backref" href="#id1">Local development environment</a><a class="headerlink" href="#local-development-environment" title="Permalink to this headline">¶</a></h1>
<p>This chapter covers getting started with Ichnaea using Docker for a local
development environment.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#local-development-environment" id="id1">Local development environment</a><ul>
<li><a class="reference internal" href="#setup-quickstart" id="id2">Setup Quickstart</a></li>
<li><a class="reference internal" href="#updating-the-dev-environment" id="id3">Updating the Dev Environment</a><ul>
<li><a class="reference internal" href="#updating-code" id="id4">Updating code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration" id="id5">Configuration</a><ul>
<li><a class="reference internal" href="#setting-configuration-specific-to-your-local-dev-environment" id="id6">Setting configuration specific to your local dev environment</a></li>
<li><a class="reference internal" href="#overriding-configuration" id="id7">Overriding configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#alembic-and-database-migrations" id="id8">Alembic and Database Migrations</a></li>
<li><a class="reference internal" href="#building-static-assets-css-js" id="id9">Building Static Assets (CSS/JS)</a></li>
<li><a class="reference internal" href="#running-tests" id="id10">Running Tests</a></li>
<li><a class="reference internal" href="#building-docs" id="id11">Building Docs</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="setup-quickstart">
<span id="localdev-quickstart"></span><h2><a class="toc-backref" href="#id2">Setup Quickstart</a><a class="headerlink" href="#setup-quickstart" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Install required software: Docker, docker-compose (1.10+), make, and git.</p>
<p><strong>Linux</strong>:</p>
<blockquote>
<div><p>Use your package manager.</p>
</div></blockquote>
<p><strong>OSX</strong>:</p>
<blockquote>
<div><p>Install <a class="reference external" href="https://docs.docker.com/docker-for-mac/">Docker for Mac</a> which
will install Docker and docker-compose.</p>
<p>Use <a class="reference external" href="https://brew.sh">homebrew</a> to install make and git:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ brew install make git
</pre></div>
</div>
</div></blockquote>
<p><strong>Other</strong>:</p>
<blockquote>
<div><p>Install <a class="reference external" href="https://docs.docker.com/engine/installation/">Docker</a>.</p>
<p>Install <a class="reference external" href="https://docs.docker.com/compose/install/">docker-compose</a>. You need
1.10 or higher.</p>
<p>Install <a class="reference external" href="https://www.gnu.org/software/make/">make</a>.</p>
<p>Install <a class="reference external" href="https://git-scm.com/">git</a>.</p>
</div></blockquote>
</li>
<li><p class="first">Clone the repository so you have a copy on your host machine.</p>
<p>Instructions for cloning are <a class="reference external" href="https://github.com/mozilla/ichnaea">on the Ichnaea page in GitHub</a>.</p>
<p>Ichnaea publishes documentation at <a class="reference external" href="https://mozilla.github.io/ichnaea">https://mozilla.github.io/ichnaea</a>
which is a git submodule in the repository.</p>
<p>After you clone the repository, you need to do this in the repository
directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git submodule update --init --recursive
</pre></div>
</div>
</li>
<li><p class="first">(<em>Optional/Advanced</em>) Set UID and GID for Docker container user.</p>
<p>If you’re on Linux or you want to set the UID/GID of the app user that
runs in the Docker containers, run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make my.env
</pre></div>
</div>
<p>Then edit the file and set the <code class="docutils literal"><span class="pre">ICHNAEA_UID</span></code> and <code class="docutils literal"><span class="pre">ICHNAEA_GID</span></code>
variables. These will get used when creating the app user in the base
image.</p>
<p>If you ever want different values, change them in <code class="docutils literal"><span class="pre">my.env</span></code> and re-run
<code class="docutils literal"><span class="pre">make</span> <span class="pre">build</span></code>.</p>
</li>
<li><p class="first">Build Docker images for Ichnaea services.</p>
<p>From the root of this repository, run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make build
</pre></div>
</div>
<p>That will build the app Docker image required for development.</p>
</li>
<li><p class="first">Initialize Redis and MySQL.</p>
<p>Then you need to set up services. To do that, run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make runservices
</pre></div>
</div>
<p>This starts service containers. Then run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make setup
</pre></div>
</div>
<p>This creates the MySQL database and sets up tables and things.</p>
<p>You can run <code class="docutils literal"><span class="pre">make</span> <span class="pre">setup</span></code> any time you want to wipe any data and start
fresh.</p>
</li>
</ol>
<p>At this point, you should have a basic functional Ichnaea development
environment that has no geo data in it.</p>
</div>
<div class="section" id="updating-the-dev-environment">
<span id="localdev-updating"></span><h2><a class="toc-backref" href="#id3">Updating the Dev Environment</a><a class="headerlink" href="#updating-the-dev-environment" title="Permalink to this headline">¶</a></h2>
<div class="section" id="updating-code">
<h3><a class="toc-backref" href="#id4">Updating code</a><a class="headerlink" href="#updating-code" title="Permalink to this headline">¶</a></h3>
<p>Any time you want to update the code in the repostory, run something like this from
the master branch:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git pull
</pre></div>
</div>
<p>It depends on what you’re working on and the state of things.</p>
<p>After you do that, you’ll need to update other things.</p>
<p>If there were changes to the requirements files or setup scripts, you’ll need to
build new images:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make build
</pre></div>
</div>
<p>If there were changes to the database tables, you’ll need to wipe the MySQL
database and Redis:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make setup
</pre></div>
</div>
</div>
</div>
<div class="section" id="configuration">
<span id="localdev-configuration"></span><h2><a class="toc-backref" href="#id5">Configuration</a><a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Configuration is pulled from these sources:</p>
<ol class="arabic simple">
<li>The <code class="docutils literal"><span class="pre">my.env</span></code> file.</li>
<li>ENV files located in <code class="docutils literal"><span class="pre">/app/docker/config/</span></code>. See <code class="docutils literal"><span class="pre">docker-compose.yml</span></code> for
which ENV files are used in which containers, and their precedence.</li>
<li>Configuration defaults defined in the code.</li>
</ol>
<p>The sources above are ordered by precedence, i.e. configuration values defined
in the <code class="docutils literal"><span class="pre">my.env</span></code> file will override values in the ENV files or defaults.</p>
<p>The following ENV files can be found in <code class="docutils literal"><span class="pre">/app/docker/config/</span></code>:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">app.env</span></code></dt>
<dd><p class="first">This holds <em>secrets</em> and <em>environment-specific configuration</em> required
to get services to work in a Docker-based local development environment.</p>
<p class="last">This should <strong>NOT</strong> be used for server environments, but you could base
configuration for a server environment on this file.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">test.env</span></code></dt>
<dd>This holds configuration specific to running the tests. It has some
configuration value overrides because the tests are “interesting”.</dd>
<dt><code class="docutils literal"><span class="pre">my.env</span></code></dt>
<dd><p class="first">This file lets you override any environment variables set in other ENV files
as well as set variables that are specific to your instance.</p>
<p>It is your personal file for your specific development environment–it
doesn’t get checked into version control.</p>
<p class="last">The template for this is in <code class="docutils literal"><span class="pre">docker/config/my.env.dist</span></code>.</p>
</dd>
</dl>
<p>In this way:</p>
<ol class="arabic simple">
<li>environmental configuration which covers secrets, hosts, ports, and
infrastructure-specific things can be set up for every environment</li>
<li>behavioral configuration which covers how the code behaves and which classes
it uses is versioned alongside the code making it easy to deploy and revert
behavioral changes with the code depending on them</li>
<li><code class="docutils literal"><span class="pre">my.env</span></code> lets you set configuration specific to your development
environment as well as override any configuration and is not checked into
version control</li>
</ol>
<div class="section" id="setting-configuration-specific-to-your-local-dev-environment">
<h3><a class="toc-backref" href="#id6">Setting configuration specific to your local dev environment</a><a class="headerlink" href="#setting-configuration-specific-to-your-local-dev-environment" title="Permalink to this headline">¶</a></h3>
<p>There are some variables you need to set that are specific to your local dev
environment. Put them in <code class="docutils literal"><span class="pre">my.env</span></code>.</p>
</div>
<div class="section" id="overriding-configuration">
<h3><a class="toc-backref" href="#id7">Overriding configuration</a><a class="headerlink" href="#overriding-configuration" title="Permalink to this headline">¶</a></h3>
<p>If you want to override configuration temporarily for your local development
environment, put it in <code class="docutils literal"><span class="pre">my.env</span></code>.</p>
</div>
</div>
<div class="section" id="alembic-and-database-migrations">
<span id="localdev-alembic"></span><h2><a class="toc-backref" href="#id8">Alembic and Database Migrations</a><a class="headerlink" href="#alembic-and-database-migrations" title="Permalink to this headline">¶</a></h2>
<p>Ichnaea uses Alembic.</p>
<p>To create a new database migration, do this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make shell
app@blahblahblah:/app$ alembic revision -m &quot;SHORT DESCRIPTION&quot;
</pre></div>
</div>
<p>Then you can edit the file.</p>
</div>
<div class="section" id="building-static-assets-css-js">
<span id="localdev-staticassets"></span><h2><a class="toc-backref" href="#id9">Building Static Assets (CSS/JS)</a><a class="headerlink" href="#building-static-assets-css-js" title="Permalink to this headline">¶</a></h2>
<p>To build CSS files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make buildcss
</pre></div>
</div>
<p>To build JS files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make buildjs
</pre></div>
</div>
</div>
<div class="section" id="running-tests">
<span id="localdev-testing"></span><h2><a class="toc-backref" href="#id10">Running Tests</a><a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>You can run the test suite like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make test
</pre></div>
</div>
<p>If you want to pass different arguments to pytest or specify specific
tests to run, open up a test shell first:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make testshell
app@blahblahblah:/app$ pytest [ARGS]
</pre></div>
</div>
</div>
<div class="section" id="building-docs">
<span id="localdev-docs"></span><h2><a class="toc-backref" href="#id11">Building Docs</a><a class="headerlink" href="#building-docs" title="Permalink to this headline">¶</a></h2>
<p>You can build the docs like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ make docs
</pre></div>
</div>
<p>This will create an application container with a volume mount to the
local <code class="docutils literal"><span class="pre">docs/build/html</span></code> directory and update the documentation so
it is available in that local directory.</p>
<p>To view the documentation open <code class="docutils literal"><span class="pre">file://docs/build/html/index.html</span></code>
with a web brower.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api/index.html" class="btn btn-neutral float-right" title="Services API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="usage.html" class="btn btn-neutral" title="Using the Service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2017, Mozilla.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>